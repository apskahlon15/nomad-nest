<% layout("/layouts/boilerplate") %>
<script>
  const coordinates = <%- JSON.stringify(listing.geometry.coordinates) %>;
</script>

<div class="container text-center">
  <h2><%= listing.title %></h2>
</div>

<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card mx-auto border-0 shadow-sm">
      <img
        class="card-img-top rounded-top"
        src="<%= listing.image.url %>"
        alt="<%= listing.title %>"
        style="height: 300px; object-fit: cover"
      />
      <div class="card-body">
        <ul class="list-unstyled">
          <li class="mb-2"><i>Posted by <%= listing.owner.username %></i></li>
          <li class="mb-2">
            <strong>Description:</strong> <%= listing.description %>
          </li>
          <li class="mb-2"><strong>Price:</strong> $<%= listing.price %></li>
          <li class="mb-2">
            <strong>Location:</strong> <%= listing.location %>
          </li>
          <li class="mb-2"><strong>Country:</strong> <%= listing.country %></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="text-center my-4">
  <% if (currentUser && currentUser._id.equals(listing.owner._id)) { %>
  <form
    method="POST"
    action="/listings/<%= listing._id %>?_method=DELETE"
    class="d-inline"
  >
    <button type="submit" class="btn btn-outline-danger me-2">
      Delete Listing
    </button>
  </form>

  <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">
    Edit this listing
  </a>
  <% } %>
</div>

<hr />

<!-- Review Form -->
<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="container my-4">
      <h5>Add a Review</h5>
      <form
        method="POST"
        action="/listings/<%= listing._id %>/reviews"
        novalidate
        class="needs-validation"
      >
        <div class="mb-3">
          <label for="reviewContent" class="form-label">Review</label>
          <textarea
            name="review[content]"
            class="form-control"
            id="reviewContent"
            rows="5"
            required
          ></textarea>
          <div class="valid-feedback">Description is great</div>
          <div class="invalid-feedback">It looks empty</div>
        </div>

        <div class="mb-3">
          <label for="rating" class="form-label">Rating (1–5)</label>
          <fieldset class="starability-checkmark">
            <legend class="visually-hidden">First rating:</legend>
            <input
              type="radio"
              id="no-rate"
              class="input-no-rate"
              name="review[rating]"
              value="0"
              checked
              aria-label="No rating."
            />
            <input
              type="radio"
              id="first-rate1"
              name="review[rating]"
              value="1"
            />
            <label for="first-rate1" title="Terrible">1 star</label>
            <input
              type="radio"
              id="first-rate2"
              name="review[rating]"
              value="2"
            />
            <label for="first-rate2" title="Not good">2 stars</label>
            <input
              type="radio"
              id="first-rate3"
              name="review[rating]"
              value="3"
            />
            <label for="first-rate3" title="Average">3 stars</label>
            <input
              type="radio"
              id="first-rate4"
              name="review[rating]"
              value="4"
            />
            <label for="first-rate4" title="Very good">4 stars</label>
            <input
              type="radio"
              id="first-rate5"
              name="review[rating]"
              value="5"
            />
            <label for="first-rate5" title="Amazing">5 stars</label>
          </fieldset>
          <div class="valid-feedback">Looks Good</div>
          <div class="invalid-feedback">Please select a rating</div>
        </div>

        <button type="submit" class="btn btn-dark">Submit Review</button>
      </form>
    </div>
  </div>
</div>

<!-- ✅ Posted Reviews Section -->
<h3 class="text-center my-4">All Reviews</h3>

<% if (listing.reviews.length === 0) { %>
<p class="text-muted text-center">No reviews yet. Be the first to add one!</p>
<% } else { %>
<div class="container" style="max-width: 40rem">
  <div class="row g-4">
    <% listing.reviews.forEach((review) => { %>
    <div class="col-md-6">
      <div class="card shadow-sm border-0 h-100 rounded-4">
        <div class="card-body d-flex flex-column justify-content-between">
          <div>
            <p class="mb-2 text-secondary fw-semibold">
              By <%= listing.owner.username %>
            </p>
            <p class="card-text" style="font-size: 0.95rem; color: #333">
              <%= review.content %>
            </p>
          </div>

          <div
            class="d-flex justify-content-between align-items-center mt-3"
            style="font-size: 0.85rem; color: #666"
          >
            <p
              class="starability-result mb-0"
              data-rating="<%= review.rating %>"
            ></p>
            <span><%= new Date(review.createdAt).toLocaleDateString() %></span>
          </div>

          <!-- Delete Review Button -->
          <form
            method="POST"
            action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
            class="mt-3"
          >
            <button
              type="submit"
              class="btn btn-sm btn-outline-danger w-100 rounded-2"
            >
              Delete Review
            </button>
          </form>
        </div>
      </div>
    </div>
    <% }) %>
  </div>
</div>
<% } %>
<div class="col-6 offset-3 mb-3">
  <h3>Where You will be</h3>
  <div id="map"></div>
</div>
<script>
  let map_token = "<%= process.env.MAP_TOKEN%>";
  mapboxgl.accessToken = map_token;

  const map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/streets-v12",
    zoom: 10,
    center: coordinates, // [Long,Lati]
    projection: "mercator",
  });

  console.log(map_token);

  const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(
    "<h6>Approximate location of your stay</h6>"
  );

  const marker = new mapboxgl.Marker({ color: "#e63946" })
    .setLngLat(coordinates)
    .setPopup(popup) // ← Popup added here
    .addTo(map);
</script>
